---
title: "04_describe"
author: Eric Torres, Lucia de Lamadrid, Konstantina Gkopi, Elena Iriondo and Jorge Santiago
format: html
editor: visual
---

## Data visualization and description

### Load packages

```{r}
#| message: false 
library(dplyr)
```

### Read data

```{r}
clean_df <- read.table('../data/03_metadata_long_filtered_taxonom.tsv', 
                       header=TRUE, 
                       sep='\t')
head(clean_df)
```

```{r}
raw_data <- read.table('../data/01_data_metadata.tsv', 
                       header=TRUE, 
                       sep='\t')
head(raw_data)
```

### Microbiota composition differences due to sex

```{r}
clean_df |> 
  filter(Donor == "Fresh") |> # Filter for LFPP and Western diets
  group_by(Sex, Phylum) |> # Group by Diet and Phylum
  summarise(mean_rel_abund = mean(rel_abundance), 
            .groups = "drop") |> # Calculate mean relative abundances
  group_by(Sex) |> 
  mutate(mean_rel_abund = mean_rel_abund / sum(mean_rel_abund)) |> # Normalize mean abundances so that the total for each diet is 1
  ggplot(aes(x = Sex,
             y = mean_rel_abund,
             fill = Phylum)) + 
  geom_bar(stat = "identity",
           position = "stack") +
  geom_hline(yintercept = 0) +
  labs(
    title = "Relative Abundance of Phyla by Sex",
    x = "Sex",
    y = "Relative Abundance",
    fill = "Phylum"
  ) +
  theme_minimal() +
  theme(legend.position = "bottom", 
        legend.text = element_text(size = 8),
        axis.text.x = element_text(angle = 45, hjust = 1))


```

As seen in the plot above there are no data for female mice in the first generation, therefore we cannot draw any conclusion. We wanted to use `Donor == "Fresh"` because when examining the differences due to `Sex`, the other variables like the transplantation or diet shouldn't be considered. If we take a look to the composition of the samples:

```{r}
clean_df |> 
  group_by(Donor, Sex) |> 
  count(Sex)
```

There are only female mice in the humanized mouse with LFPP diet graft, and the differences in sample size are huge in comparison to male individuals. Thus, this analysis cannot be done.

### Microbiota composition in terms of phyla and class in different sources and diet types

```{r}
clean_df |> 
  filter(Diet %in% c("LFPP", "Western")) |> 
  group_by(Source, Diet) |> 
  mutate(norm_rel_abundance = rel_abundance / sum(rel_abundance)) |> # Normalize abundance within samples
  group_by(Source, Diet, Phylum) |> 
  summarise(mean_rel_abund = mean(norm_rel_abundance), 
            .groups = "drop") |> # Calculate the mean relative abundances
  group_by(Source, Diet) |> 
  mutate(mean_rel_abund = mean_rel_abund / sum(mean_rel_abund)) |> # Normalize mean abundances so that the total for each one is 1
  ggplot(aes(x = Source,
             y = mean_rel_abund,
             fill = Phylum)) + 
  geom_bar(stat = "identity",
           position = "stack") +
  geom_hline(yintercept = 0) +
  facet_wrap(~ Diet) + 
  labs(
    title = "Relative Abundance of Phyla per source and diet type",
    x = "Source type",
    y = "Relative Abundance",
    fill = "Phyla"
  ) +
  theme_minimal() +
  theme(legend.position = "bottom", # change when data augmentation has been done
        legend.text = element_text(size = 8),
        axis.text.x = element_text(angle = 45, hjust = 1))
```

If we observe the above figure we can find some interesting insights. Firstly, we can find differences in phyla's relative abundance among the different parts of the mice's gut; but the differences are noteworthy between diet types, showing a lower abundance of *Proteobacteria* and higher *Verrucomicrobia* in Western diet compared to the LFPP diet.

```{r}
clean_df |> 
  filter(Diet %in% c("LFPP", "Western")) |> 
  group_by(Source, Diet) |> 
  mutate(norm_rel_abundance = rel_abundance / sum(rel_abundance)) |> # Normalize abundance within samples
  group_by(Source, Diet, Class) |> 
  summarise(mean_rel_abund = mean(norm_rel_abundance), .groups = "drop") |> # Calculate the mean relative abundances
  group_by(Source, Diet) |> 
  mutate(mean_rel_abund = mean_rel_abund / sum(mean_rel_abund)) |> # Normalize mean abundances so that the total for each one is 1
  ggplot(aes(x = Source,
             y = mean_rel_abund,
             fill = Class)) + 
  geom_bar(stat = "identity",
           position = "stack") +
  geom_hline(yintercept = 0) +
  facet_wrap(~ Diet) + 
  labs(
    title = "Relative Abundance of Class per source and diet type",
    x = "Source type",
    y = "Relative Abundance",
    fill = "Class"
  ) +
  theme_minimal() +
  theme(legend.position = "bottom", # change when data augmentation has been done
        legend.text = element_text(size = 8),
        axis.text.x = element_text(angle = 45, hjust = 1))

```

### Microbiota composition of mice with different diet and donor combination (relative abundance of phyla)

In order to compare the general composition of the microbiota in the mice with different donor and diet, we may represent the relative abundance of the most prevalent phyla.

```{r}
clean_df |> 
  filter(Diet %in% c("LFPP", "Western") & Donor %in% c("Fresh", "HMouseLFPP", "HMouseWestern") & Source != "Fecal" ) |> 
  group_by(Donor, Diet) |> 
  mutate(norm_rel_abundance = rel_abundance / sum(rel_abundance)) |> # Normalize abundance within samples
  group_by(Donor, Diet, Phylum) |> 
  summarise(mean_rel_abund = mean(norm_rel_abundance), 
            .groups = "drop") |> # Calculate the mean relative abundances
  group_by(Donor, Diet) |> 
  mutate(mean_rel_abund = mean_rel_abund / sum(mean_rel_abund)) |> # Normalize mean abundances so that the total for each one is 1
  ggplot(aes(x = Donor,
             y = mean_rel_abund,
             fill = Phylum)) + 
  geom_bar(stat = "identity",
           position = "stack") +
  geom_hline(yintercept = 0) +
  facet_wrap(~ Diet) + 
  labs(
    title = "Relative Abundance of Phyla per donor and diet type",
    x = "Donor type",
    y = "Relative Abundance",
    fill = "Phylum"
  ) +
  theme_minimal() +
  theme(legend.position = "bottom",
        legend.text = element_text(size = 8),
        axis.text.x = element_text(angle = 45, hjust = 1))

```

This plot is very informative, as it allows us to explore several of the different experiments carried out by the original authors of the dataset:

-   Overall, we can see that the Western diet leads to a lower proportion of Bacteroidetes and unclassified phyla, and a higher one of Verrucomicrobia

-   When focusing on the first generation of humanised mice ("Fresh" donor), we can see that diet greatly affects the microbiota composition. The LF-PP diet leads to a much higher proportion of Bacteroidetes and a much smaller one of Actinobacteria. Furthermore, there are less bacteria belonging to unclassified phyla in the Western diet, and more Verrucomicrobia

-   Regarding the second generation of humanised mice ("Hmouse..." donor), we can observe that the bars with the same donor are more similar to each other ("HmouseLFPP" versus "HmouseWestern") than those with the same diet ("LFPP" vs "Western"). This indicates that the diet that their "donor" followed may be more determinant in the composition of their gut microbiota than the diet the mice follow themselves.

-   Though the diet factor has the most obvious effect on the first generation of humanised mice, the diet followed also visibly influenced the microbiota of the second generation of humanised mice. For instance, mice with donors on the LFPP diet ("HmouseLFPP" donor) presented starkly different proportions of Verrucomicrobia and Bacteroidetes depending on their current diet.

### Firmicutes-Bacteroidetes Ratio

The Firmicutes-Bacteroidetes ratio is a wel-known marker for obesity (<https://doi.org/10.1038/4441022a>). As we lack the fat content and other more direct measures of this condition, we will now calculate the Firmicutes-Bacteroidetes ratio of the mice following each diet. In order to solely test if the diet may be linked to obesity, we will calculate this ratio solely for the first generation of humanised mice (donor is "Fresh")ยบ.

```{r}
ratio_data <- clean_df |> 
  filter(Diet %in% c("LFPP", "Western") & Donor == "Fresh" & Source != "Fecal" ) |>
  group_by(Diet) |> 
  summarise(Firmicutes = sum(rel_abundance[Phylum == "Firmicutes"]),
            Bacteroidetes = sum(rel_abundance[Phylum == "Bacteroidetes"])) |> 
  mutate(Ratio = Firmicutes / Bacteroidetes)
ratio_data
```

As observed in the previous section, this ratio is bigger in the Western diet (less Bacteroidetes and more Firmicutes proportionately).

### Biodiversity of humanised mice microbiota with different diet

We can use diversity indices in order to quantify biodiversity. As we know the relative abundance of each OTU, we can use the Shannon diversity index. Based on Claude Shannon's formula for entropy, this popular ecological metric takes into account the number of species living in a habitat (richness) and their relative abundance (evenness).

The formula we will use is:

$$
H' = -\sum_{i=1}^R p_i \ln p_i \\
p_i \text{ is the relative abundance of OTU}_i\\ R \text{ is the total number of OTUs}
$$

We will compare this index for first generation humanised mice following each diet. For this purpose, we will use the original raw data, in which all OTU counts (including the less abundant ones) are included.

We first store the diet column in a dataframe.

```{r}
diet_data <- raw_data |> 
  filter(Donor == 3 & Source != 4 & Diet %in% c(0, 1)) |> #we select 1st generation humanised mice (donor is fresh), get rid of microbiota samples that were not taken at the time of sacrifice (source is not fecal), and we select the LFPP (0) and Western (1) diets
  select(Diet) |> 
  mutate(Diet = case_when(Diet == 0 ~ "LFPP",
                          Diet == 1 ~ "Western"))
```

We calculate the Shannon index for each row and save it in a new dataframe.

```{r}
shannon <- raw_data |> 
  filter(Donor == 3 & Source != 4 & Diet %in% c(0, 1)) |> #same filters as before
  select(starts_with("OTU")) |> #we only need the OTU columns to calculate the index 
  mutate(across(everything(), ~ (-1)*.x * log(.x))) |> #we transform each OTU relative abundance column (p_i) into p_i*log(p_i) 
  rowwise() |> #we apply the following operations row by row
  mutate(
    sum_all_columns = sum(across(everything()), na.rm = TRUE), #we add the products to calculate the shannon_index
    .keep = "unused") |> #we only keep the new shannon index column
  ungroup()
shannon
```

We combine both dataframes and calculate the Shannon index and its standard deviation for each diet.

```{r}
combined_df <- bind_cols(diet_data, shannon)  #combination of both dataframes
final_shannon <- combined_df |> #generate a final data frame with the shannon index and sd for each diet
  group_by(Diet) |>
  summarise(
    shannon_index= mean(sum_all_columns),
    standard_dev = sd(sum_all_columns)
  )
final_shannon
```

Finally, we plot the index for each of the studied diets.

```{r}
# Plot with error bars
ggplot(final_shannon, aes(x = Diet, y = shannon_index)) +
  geom_col(aes(fill = Diet), width = 0.6) +  # Adjust column width
  geom_errorbar(aes(ymin = shannon_index - standard_dev, ymax = shannon_index + standard_dev), 
                width = 0.2) +  # Error bar width
  labs(
    title = "Biodiversity in microbiota",
    x = "Diet",
    y = "Shannon diversity index"
  ) +
  theme_minimal() +
  theme(
    legend.position = "none",  # Remove legend
    plot.title = element_text(size = 16, hjust = 0.5),  # Big centered title
    axis.title = element_text(size = 14),  # Large axis labels
    axis.text = element_text(size = 12)    # Large axis text
  )
```

Interestingly, the Western diet leads to a more biodiverse microbiota than the "healthier" LF-PP diet in the humanised mice. This is in line with the results of representing the microbiota composition in function of phylum, in which the different type of phyla were more evenly distributed in the Western diet.
